"""
part.py
오디오 드라마 본편 파트 생성 모듈 (Part 1-4)
"""

PART_PROMPT = """
당신은 유튜브 오디오 드라마 작가입니다.

【제목】
{title}

【전체 개요】
{outline_full}

{previous_parts_text}

【당신의 과제】
{part_instruction}

━━━━━━━━━━━━━━━━━━━━
⭐⭐⭐ 핵심 규칙 ⭐⭐⭐
나레이션 90~95%
대사 5~10%
500-1000자마다 대사 1회 정도
대사 없는 긴 장면 많아야 함
━━━━━━━━━━━━━━━━━━━━

【필수 문체 규칙】

1. 화자
전지적 3인칭 단일 내레이터
"그는", "그녀는", "민서는" 사용
절대 "나는", "내가" 금지

2. 대사 최소화 ⭐⭐⭐
대사는 정말 중요한 순간에만 사용하세요:
- 첫 만남의 한마디
- 충격적 고백
- 결정적 질문
- 감정의 폭발{climax_dialogue_rule}

대사 형식:
"대사" → 누가 말했는지 명시 → 어떻게 말했는지/반응

좋은 예:
"괜찮아요." 민서가 떨리는 목소리로 대답했습니다. 눈가에 눈물이 맺혔어요.

나쁜 예:
"괜찮아요."
(화자 없음, 반응 없음)

3. 종결어미 혼용
자연스럽게 섞어 쓰세요:
- ~습니다/했습니다: 중요 사건, 전환점
- ~어요/아요/였어요: 일상 묘사, 감정 표현
- ~죠/거든요/니까요: 이유 설명, 배경 설명

예시:
"서영은 국밥집으로 향했습니다. 문을 열자 따뜻한 김이 올랐어요. 점심시간이라 손님이 많았거든요."

4. 나레이션 전개 방식

【시공간 설정부터】
"비 오는 밤", "한편 그 시각", "며칠이 지난 어느 오후"

예시:
"비가 억수같이 쏟아지는 밤이었습니다."
"한편, 강일성 회장은 검은 세단 안에 앉아 있었어요."

【행동 + 감각】
"~를 느끼며", "~를 바라보며", "~를 듣고"

예시:
"민서는 차가운 빗물을 느끼며 핸들을 꽉 쥐었어요."
"일성은 사진을 바라보며 긴 한숨을 내쉬었습니다."

【내면은 나레이션으로】
대사 아닌 혼잣말, 생각, 동기를 나레이션으로 전환

예시:
"제발 버텨줘. 민서는 속으로 빌었습니다."
"할머니 병원비를 내야 했어요."

【"한편"으로 인물 교차】
두 인물의 시점을 번갈아 보여주며 충돌 예고

예시:
"민서는 배달을 서두르고 있었습니다. 한편 같은 시각, 강회장은 병원으로 향하고 있었어요."

【과거 자연스럽게 삽입】
"~년 전", "그때", "그날"

예시:
"18년 전 그날도 비가 왔습니다."
"그때 일성은 모든 것을 잃었어요."

【템포 조절】
느린 장면: 디테일, 감각 묘사, 긴 문장 (감정, 회상)
빠른 장면: 핵심만, 짧은 문장 (전환, 충격)

느린 예시:
"민서는 헬멧 안쪽으로 스며드는 차가운 빗물을 느끼며 악셀을 더 세게 밟았습니다. 낡은 브레이크에서는 쇠 긁는 소리가 났고, 빗길에 미끄러질 뻔한 게 한두 번이 아니었어요."

빠른 예시:
"쿵. 부딪혔습니다. 민서가 땅에 쓰러졌어요. 회장이 차에서 내렸습니다."

5. 감정 표현
감정을 직접 말하지 말고 신체 반응으로만:

"슬펐다" (X) → "눈물이 흘렀다" (O)
"화났다" (X) → "주먹을 쥐었다" (O)
"놀랐다" (X) → "심장이 멎는 듯했다" (O)
"의심했다" (X) → "눈을 가늘게 떴다" (O)
"행복했다" (X) → "미소가 번졌다" (O)

6. 문장 길이 조절
상황에 맞게 자연스럽게 섞어 쓰세요:

짧은 문장 (10-20자): 충격적인 순간, 장면 전환
"숨이 멎었습니다."
"그는 돌아섰어요."

중간 문장 (30-60자): 기본 서술 (가장 많이 사용)
"민서는 배달 가방을 메고 스쿠터에 올라탔습니다."

긴 문장 (70-120자): 감정 묘사, 과거 회상
"18년 전 그날도 이렇게 비가 내렸고, 그날도 이 병원 앞에서 모든 것이 끝났으며, 그 이후로 일성의 삶은 텅 비어버렸습니다."

7. 오디오 중심
시각 의존 최소화, 소리로 전달

의성어: "똑똑", "쿵", "끼익", "쏴아"
목소리: "떨리는 목소리로", "조용히", "크게", "숨을 몰아쉬며"
침묵: "아무 말도 하지 않았다", "침묵만 흘렀다", "고요했습니다"

예시:
"똑똑. 문 두드리는 소리가 들렸습니다."
"끼익. 문이 천천히 열렸어요."

8. 장면 전환
장면이 바뀔 때 명확한 신호:

시간: "그날 밤", "며칠 후", "다음날 아침", "1년이 지나고"
공간: "한편", "~로 향했다", "~에 도착했습니다"
회상: "30년 전, ~였습니다", "그때를 떠올렸어요"

【중요】
나레이션이 스토리를 이끌어야 합니다.
대사는 정말 필요한 순간에만.
대사 없이 나레이션만으로 진행되는 긴 장면이 많아야 합니다.

【자유로운 영역】
위의 문체 규칙만 지키면:
- 스토리 전개 방향
- 갈등의 강도
- 캐릭터 성격
- 장르와 톤

모두 자유롭게 창작하세요.

단, 50~80대가 이해할 수 있는 범위에서:
- 복잡한 SF, 판타지 지양
- 현실적 갈등 중심
- 가족, 인간관계 소재

【출력】
순수 텍스트 {target_length}자

{ending_note}

지금 바로 작성하세요.
"""


# Part별 설정
PART_CONFIGS = {
    1: {
        "instruction": "Part 1을 작성하세요.\n\n전체의 시작~1/4 구간입니다.\n- 훅 직후 자연스럽게 시작\n- 주요 인물 소개\n- 사건 발생\n- 갈등의 시작",
        "target_length": "12,000~13,000",
        "climax_dialogue_rule": "",
        "ending_note": ""
    },
    2: {
        "instruction": "Part 2를 작성하세요.\n\n전체의 2/4 구간입니다.\n- 갈등 심화\n- 진실에 접근\n- 긴장감 고조",
        "target_length": "12,000~13,000",
        "climax_dialogue_rule": "",
        "ending_note": ""
    },
    3: {
        "instruction": "Part 3를 작성하세요.\n\n전체의 3/4 구간입니다.\n- 클라이맥스\n- 진실 폭로\n- 가장 극적인 순간",
        "target_length": "12,000~13,000",
        "climax_dialogue_rule": "\n\n클라이맥스에서만 예외적으로 대사 25-30자 허용합니다.",
        "ending_note": ""
    },
    4: {
        "instruction": "Part 4를 작성하세요.\n\n전체의 마지막 1/4 구간입니다.\n- 갈등 해소\n- 결말\n- 여운",
        "target_length": "11,500~12,500",
        "climax_dialogue_rule": "",
        "ending_note": '※ 마지막 구독 유도 멘트는 자동으로 추가되므로 작성하지 마세요:\n"오늘의 이야기가 당신의 마음에 작은 울림을 드렸다면 구독과 좋아요를 눌러주세요. 당신의 오늘을 늘 응원합니다."'
    }
}


def generate_part_prompt(title: str, outline: str, previous_parts: list = None) -> str:
    """
    파트 생성 프롬프트 생성
    입력 개수로 Part 번호 자동 판단

    Args:
        title: 오디오 드라마 제목
        outline: 전체 개요
        previous_parts: 이전 파트들의 요약 리스트

    Returns:
        완성된 프롬프트
    """
    if previous_parts is None:
        previous_parts = []

    part_number = len(previous_parts) + 1

    if part_number not in PART_CONFIGS:
        raise ValueError(f"Invalid part number: {part_number}. Must be 1-4.")

    config = PART_CONFIGS[part_number]

    # 이전 파트 텍스트 생성
    if previous_parts:
        prev_text = "\n".join([
            f"【Part {i} 요약】\n{summary}"
            for i, summary in enumerate(previous_parts, 1)
        ])
    else:
        prev_text = ""

    # 프롬프트 조립
    prompt = PART_PROMPT.format(
        title=title,
        outline_full=outline,
        previous_parts_text=prev_text,
        part_instruction=config["instruction"],
        climax_dialogue_rule=config["climax_dialogue_rule"],
        target_length=config["target_length"],
        ending_note=config["ending_note"]
    )

    return prompt
